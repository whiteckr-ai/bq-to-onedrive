name: bq-to-onedrive-xlsx (rclone)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "45 * * * *"   # UTC 기준, 필요시 조정

jobs:
  export-and-upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1) GCP 인증
      - name: Auth to GCP
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SERVICE_ACCOUNT_JSON }}

      # 2) gcloud/bq 설치
      - name: Install gcloud & bq
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          install_components: bq

      # (선택) 진단
      - name: Check gcloud/bq
        run: |
          gcloud --version
          bq version
          gcloud auth list
          gcloud config list

      # (선택) 스모크 테스트
      - name: Smoke test - SELECT 1
        run: |
          bq query \
            --project_id="${{ secrets.GCP_PROJECT_ID }}" \
            --location=asia-northeast3 \
            --nouse_legacy_sql \
            --format=csv \
            "SELECT 1 AS ok"

      # 3) BigQuery → CSV
      - name: Export BigQuery result to CSV (robust)
        env:
          BQ_SQL: ${{ secrets.BQ_SQL }}
        run: |
          set -euo pipefail
          if [ -z "${BQ_SQL:-}" ]; then
            echo "ERROR: BQ_SQL secret is empty."; exit 1
          fi
          printf '%s' "$BQ_SQL" > /tmp/query.sql
          mkdir -p /tmp/export
          bq query \
            --project_id="${{ secrets.GCP_PROJECT_ID }}" \
            --location=asia-northeast3 \
            --nouse_legacy_sql \
            --format=csv \
            --max_rows=1000000000 \
            < /tmp/query.sql | tee /tmp/export/bq_export.csv > /dev/null

      - name: Check CSV row count & size
        run: |
          ls -l /tmp/export/bq_export.csv || true
          echo "Line count (including header):"
          wc -l /tmp/export/bq_export.csv || true
          echo "Head:"; head -n 3 /tmp/export/bq_export.csv || true
          echo "Tail:"; tail -n 3 /tmp/export/bq_export.csv || true

      # 3-1) CSV → XLSX 변환
      - name: Convert CSV to Excel (XLSX)
        run: |
          pip install --quiet pandas openpyxl
          python - <<'PY'
          import pandas as pd, re

          src = "/tmp/export/bq_export.csv"
          dst = "/tmp/export/bq_export.xlsx"

          # CSV 읽기 (문자형으로 읽고 메모리 경고 방지)
          df = pd.read_csv(src, dtype=str, encoding="utf-8-sig", low_memory=False)

          # NaN -> "" (문자 처리 쉽게)
          df = df.fillna("")

          # Excel에서 금지된 제어문자 제거: \x00-\x08 \x0B \x0C \x0E-\x1F
          illegal = re.compile(r"[\x00-\x08\x0B\x0C\x0E-\x1F]")
          df = df.applymap(lambda v: illegal.sub("", v) if isinstance(v, str) else v)

          # 시트명은 안전하게 고정 (31자 제한/특수문자 제한 회피)
          with pd.ExcelWriter(dst, engine="openpyxl") as w:
              df.to_excel(w, index=False, sheet_name="Sheet1")
          print("Saved:", dst)
          PY
          ls -l /tmp/export/bq_export.xlsx


      # 4) rclone 설치 + config 주입
      - name: Install rclone and inject config
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_B64 }}" | base64 -d > ~/.config/rclone/rclone.conf
          rclone version
          rclone lsd onedrive: || { echo "onedrive remote not working"; exit 1; }

      # (선택) 결과 파일 아티팩트 업로드
      - name: Upload XLSX artifact (for inspection)
        uses: actions/upload-artifact@v4
        with:
          name: bq_export_xlsx_from_action
          path: /tmp/export/bq_export.xlsx

      # 5) OneDrive 공유 폴더로 업로드(덮어쓰기)
      - name: Upload to OneDrive (overwrite)
        env:
          TARGET_DIR: "바탕 화면 1/raw data"    # 공유받은 폴더 경로 (슬래시 / 사용)
          TARGET_FILE: "bigquery_export.xlsx"
        run: |
          rclone copyto /tmp/export/bq_export.xlsx "onedrive:${TARGET_DIR}/${TARGET_FILE}" -P
