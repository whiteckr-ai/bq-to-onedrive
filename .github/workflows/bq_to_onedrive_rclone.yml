name: bq-to-onedrive-csv (rclone)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "45 * * * *"

jobs:
  export-and-upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1) 먼저 '인증'을 한다 (SERVICE_ACCOUNT_JSON 사용)
      - name: Auth to GCP
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SERVICE_ACCOUNT_JSON }}

      # 2) 그 다음 gcloud/bq 설치 (auth 뒤에 와야 함)
      - name: Install gcloud & bq
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          install_components: bq

      # (optional) 진단용: gcloud/bq 버전 및 인증 상태 확인
      - name: Check gcloud/bq
        run: |
          gcloud --version
          bq version
          gcloud auth list
          gcloud config list

      # 3) BigQuery → CSV
      - name: Export BigQuery result to CSV
        env:
          BQ_SQL: ${{ secrets.BQ_SQL }}
        run: |
          mkdir -p /tmp/export
          bq query \
            --project_id="${{ secrets.GCP_PROJECT_ID }}" \
            --location=asia-northeast3 \
            --nouse_legacy_sql \
            --format=csv \
            "${BQ_SQL}" > /tmp/export/bq_export.csv

      # 4) (선택) 엑셀 한글 깨짐 방지
      - name: Add UTF-8 BOM (optional)
        run: |
          python - << 'PY'
          p="/tmp/export/bq_export.csv"
          d=open(p,"rb").read()
          open(p,"wb").write(b'\xef\xbb\xbf'+d if not d.startswith(b'\xef\xbb\xbf') else d)
          PY

      # 5) rclone 설치 + 설정 주입
      - name: Install rclone and inject config
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          printf "%s" "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
          rclone version

      # 6) OneDrive에 같은 파일명으로 '덮어쓰기'
      - name: Upload to OneDrive (overwrite)
        env:
          TARGET_DIR: "Reports"
          TARGET_FILE: "bigquery_export.csv"
        run: |
          rclone copyto /tmp/export/bq_export.csv "onedrive:${TARGET_DIR}/${TARGET_FILE}" -P
