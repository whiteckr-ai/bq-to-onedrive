name: bq-to-onedrive-csv (rclone)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "45 * * * *"     # 필요시 조정하세요 (UTC)

jobs:
  export-and-upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1) GCP 인증 (서비스 계정 JSON)
      - name: Auth to GCP
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SERVICE_ACCOUNT_JSON }}

      # 2) gcloud/bq 설치 (auth 뒤에!)
      - name: Install gcloud & bq
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          install_components: bq

      # (선택) 진단용
      - name: Check gcloud/bq
        run: |
          gcloud --version
          bq version
          gcloud auth list
          gcloud config list

      # (선택) 스모크 테스트 - 권한/리전 빠르게 검증
      - name: Smoke test - SELECT 1
        run: |
          bq query \
            --project_id="${{ secrets.GCP_PROJECT_ID }}" \
            --location=asia-northeast3 \
            --nouse_legacy_sql \
            --format=csv \
            "SELECT 1 AS ok"

      # 3) BigQuery → CSV
      - name: Export BigQuery result to CSV (robust)
        env:
          BQ_SQL: ${{ secrets.BQ_SQL }}
        run: |
          set -euo pipefail

          # 0) 쿼리 유효성 검사
          if [ -z "${BQ_SQL:-}" ]; then
            echo "ERROR: BQ_SQL secret is empty."
            exit 1
          fi

          # 1) 쿼리를 파일로 저장하고 길이/미리보기는 안전하게만 출력
          printf '%s' "$BQ_SQL" > /tmp/query.sql
          echo "Query bytes:"
          wc -c /tmp/query.sql || true
          echo "Query preview (first 120 chars, redacted):"
          head -c 120 /tmp/query.sql | sed 's/./*/g' || true
          echo

          # 2) bq 실행 (에러 메시지 확인 위해 --quiet 제거), 출력은 tee로 파일에 확실히 저장
          mkdir -p /tmp/export
          bq query \
            --project_id="${{ secrets.GCP_PROJECT_ID }}" \
            --location=asia-northeast3 \
            --nouse_legacy_sql \
            --format=csv \
            --max_rows=0 \
            < /tmp/query.sql | tee /tmp/export/bq_export.csv > /dev/null

          # 3) 결과 점검
          echo "=== Result file stats ==="
          ls -l /tmp/export/bq_export.csv || true
          echo "Line count (including header):"
          wc -l /tmp/export/bq_export.csv || true
          echo "Head:"
          head -n 3 /tmp/export/bq_export.csv || true
          echo "Tail:"
          tail -n 3 /tmp/export/bq_export.csv || true


      # (선택) 엑셀 한글 깨짐 방지: UTF-8 BOM 추가
      - name: Add UTF-8 BOM (optional)
        run: |
          python - << 'PY'
          p="/tmp/export/bq_export.csv"
          d=open(p,"rb").read()
          open(p,"wb").write(b'\xef\xbb\xbf'+d if not d.startswith(b'\xef\xbb\xbf') else d)
          PY

      # 4) rclone 설치 + base64로 받은 config 주입
      - name: Install rclone and inject config
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_B64 }}" | base64 -d > ~/.config/rclone/rclone.conf
          rclone version
          # 원격 연결 테스트(에러 시 바로 종료)
          rclone lsd onedrive: || { echo "onedrive remote not working"; exit 1; }

      # 4.1) 결과 파일 확인 (행 개수, 앞/뒤 미리보기)
      - name: Check row count & size
        run: |
          ls -l /tmp/export/bq_export.csv || true
          echo "Line count (including header):"
          wc -l /tmp/export/bq_export.csv || true
          echo "Head:"
          head -n 3 /tmp/export/bq_export.csv || true
          echo "Tail:"
          tail -n 3 /tmp/export/bq_export.csv || true

      # 4.2) CSV 아티팩트 업로드 (워크플로우 실행 결과에서 다운로드 가능)
      - name: Upload CSV artifact (for inspection)
        uses: actions/upload-artifact@v4
        with:
          name: bq_export_from_action
          path: /tmp/export/bq_export.csv

      # 5) OneDrive에 같은 파일명으로 덮어쓰기 업로드
      - name: Upload to OneDrive (overwrite)
        env:
          TARGET_DIR: "Reports"                  # 원드라이브 폴더
          TARGET_FILE: "bigquery_export.csv"     # 항상 같은 파일명
        run: |
          rclone copyto /tmp/export/bq_export.csv "onedrive:${TARGET_DIR}/${TARGET_FILE}" -P

      # (선택) 날짜 백업도 남기고 싶다면 아래 주석 해제
      # - name: Upload dated backup (optional)
      #   run: |
      #     dt=$(date +%Y%m%d)
      #     rclone copyto /tmp/export/bq_export.csv "onedrive:Reports/bq_export_${dt}.csv" -P
