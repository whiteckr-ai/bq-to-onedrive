name: bq-to-onedrive-csv (rclone)

on:
  schedule:
    - cron: "45 * * * *"      # 자동 실행(UTC). 테스트만 할거면 아래 workflow_dispatch만 써도 됨
  workflow_dispatch: {}

jobs:
  export-and-upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # gcloud / bq 설치
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          install_components: "bq"

      # GCP 인증
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SERVICE_ACCOUNT_JSON }}

      # BigQuery → CSV
      - name: Export BigQuery result to CSV
        env:
          BQ_SQL: ${{ secrets.BQ_SQL }}
        run: |
          mkdir -p /tmp/export
          bq query \
            --project_id="${{ secrets.GCP_PROJECT_ID }}" \
            --location=asia-northeast3 \
            --nouse_legacy_sql \
            --format=csv \
            "${BQ_SQL}" > /tmp/export/bq_export.csv

      # (선택) 한글 깨짐 방지
      - name: Add UTF-8 BOM (optional)
        run: |
          python - << 'PY'
          p="/tmp/export/bq_export.csv"
          d=open(p,"rb").read()
          open(p,"wb").write(b'\xef\xbb\xbf'+d if not d.startswith(b'\xef\xbb\xbf') else d)
          PY

      # rclone 설치 + 설정 주입
      - name: Install rclone and inject config
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          printf "%s" "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
          rclone version

      # OneDrive에 같은 이름으로 덮어쓰기
      - name: Upload to OneDrive (overwrite)
        env:
          TARGET_DIR: "Reports"                 # 원드라이브 폴더(없으면 자동 생성)
          TARGET_FILE: "bigquery_export.csv"    # 항상 같은 파일명
        run: |
          rclone copyto /tmp/export/bq_export.csv "onedrive:${TARGET_DIR}/${TARGET_FILE}" -P
